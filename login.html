<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Huddle — Log In</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        :root { --light-bg: #f0f2f5; --dark-text: #2c3e50; --card-bg: #ffffff; --accent1: #005c97; --accent2: #00c9a7; --shadow-color: rgba(0, 92, 151, 0.1); }
        body { background: var(--light-bg); overflow: hidden; position: relative; height: 100vh; display: flex; justify-content: center; align-items: center; color: var(--dark-text); }
        #hero-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .login-panel { width: 90%; max-width: 400px; background: var(--card-bg); border-radius: 20px; padding: 40px; box-shadow: 0 15px 40px var(--shadow-color); border: 1px solid #e0e0e0; z-index: 10; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 1.8rem; font-weight: 700; background: linear-gradient(to right, var(--accent1), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .form-group { margin-bottom: 22px; position: relative; }
        .form-group i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #aaa; }
        .form-group input { width: 100%; padding: 14px 15px 14px 45px; background: #f7f7f9; border: 1px solid #ddd; border-radius: 12px; font-size: 1rem; outline: none; transition: all 0.3s ease; }
        .form-group input:focus { border-color: var(--accent1); box-shadow: 0 0 0 3px rgba(0, 92, 151, 0.2); }
        .submit-btn { width: 100%; padding: 14px; background: linear-gradient(to right, var(--accent1), var(--accent2)); border: none; border-radius: 12px; color: white; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 148, 167, 0.45); }
        .submit-btn:disabled { background: #ccc; cursor: not-allowed; }
        .signup-link { text-align: center; margin-top: 25px; color: #556778; font-size: 0.87rem; }
        .signup-link a { color: var(--accent1); text-decoration: none; font-weight: 600; }
    </style>
</head>
<body>
    <div id="hero-canvas"></div>
    <div class="login-panel">
        <div class="header"><h1>Log in to Huddle</h1></div>
        <form id="loginForm">
            <div class="form-group"><i class="fas fa-envelope"></i><input type="email" id="email" placeholder="Email address" required></div>
            <div class="form-group"><i class="fas fa-lock"></i><input type="password" id="password" placeholder="Password" required></div>
            <button type="submit" class="submit-btn" id="loginBtn">Log In</button>
        </form>
        <div class="signup-link">Don't have an account? <a href="sign-up.html">Sign up</a></div>
    </div>
    
    <script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.178.0/build/three.module.js" } }</script>
    <script type="module">
        import * as THREE from 'three';
        // --- Background Particle Animation ---
        const container = document.getElementById('hero-canvas');
        if (container) {
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);
            camera.position.z = 5;
            const particlesGeometry = new THREE.BufferGeometry();
            const positions = new Float32Array(5000 * 3);
            for (let i = 0; i < 5000 * 3; i++) { positions[i] = (Math.random() - 0.5) * 20; }
            particlesGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            const particles = new THREE.Points(particlesGeometry, new THREE.PointsMaterial({ color: 0x005c97, size: 0.02, blending: THREE.AdditiveBlending, transparent: true, depthWrite: false }));
            scene.add(particles);
            const animate = () => { requestAnimationFrame(animate); particles.rotation.y = Date.now() * 0.00015; renderer.render(scene, camera); };
            animate();
        }

        // --- Login Form Handler ---
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.textContent = 'Logging In...';

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('http://127.0.0.1:5000/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const result = await response.json();
                if (response.ok) {
                    alert(`✅ Success! ${result.message}`);
                    localStorage.setItem('huddleUser', JSON.stringify(result.user));
                    
                    // If the user is in a team, the server will return it. Store it.
                    if (result.currentTeam) {
                        localStorage.setItem('currentTeam', JSON.stringify(result.currentTeam));
                    } else {
                        // Ensure any old team data is cleared on a fresh login
                        localStorage.removeItem('currentTeam');
                    }
                    
                    window.location.href = 'mainpage.html';
                } else {
                    alert(`❌ Login Failed: ${result.error}`);
                }
            } catch (error) {
                alert('❌ Network Error: Could not connect to the server.');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Log In';
            }
        });
    </script>
</body>
</html>